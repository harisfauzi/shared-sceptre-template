---
Description: {{sceptre_user_data.description|default('GuardDuty Malware Protection Plan(s) for '+sceptre_user_data.project_code)}}
AWSTemplateFormatVersion: "2010-09-09"

Resources:
{%- for malware_protection_plan in sceptre_user_data.malware_protection_plans %}
{%- set malware_protection_plan_name = malware_protection_plan.name %}
  {{ malware_protection_plan_name }}:
    Type: AWS::GuardDuty::MalwareProtectionPlan
    DeletionPolicy: {{ malware_protection_plan.deletion_policy | default('Delete') }}
    UpdateReplacePolicy: {{ malware_protection_plan.update_replace_policy | default('Delete') }}
    Properties:
      ProtectedResource:
        S3Bucket:
{%- if malware_protection_plan.protected_resource.s3_bucket.bucket_name is defined %}
          BucketName: {{ malware_protection_plan.protected_resource.s3_bucket.bucket_name }}
{%- endif %}
{%- if malware_protection_plan.protected_resource.s3_bucket.object_prefixes is defined %}
          ObjectPrefixes:
{%- for prefix in malware_protection_plan.protected_resource.s3_bucket.object_prefixes %}
            - {{ prefix }}
{%- endfor %}
{%- endif %}
      Role: {{ malware_protection_plan.role | trim }}
{%- if malware_protection_plan.actions is defined %}{# BEGIN if malware_protection_plan.actions is defined #}
      Actions:
{%- if malware_protection_plan.actions.tagging is defined %}{# BEGIN if malware_protection_plan.actions.tagging is defined #}
        Tagging:
{%- if malware_protection_plan.actions.tagging.status is defined %}{# BEGIN if malware_protection_plan.actions.tagging.status is defined #}
          Status: {{ malware_protection_plan.actions.tagging.status }}
{%- endif %}{# END if malware_protection_plan.actions.tagging.status is defined #}
{%- endif %}{# END if malware_protection_plan.actions.tagging is defined #}
{%- endif %}{# END if malware_protection_plan.actions is defined #}
      Tags:
        - Key: SourceRepoURL
          Value: {{ sceptre_user_data.source_repo_url | default('unknown') }}
{%- if malware_protection_plan.tags is defined %}
{%- for key,value in malware_protection_plan.tags.items() %}
        - Key: {{ key }}
          Value: {{ value }}
{%- endfor %}
{%- endif %}
{%- endfor %}

Outputs:
{%- for malware_protection_plan in sceptre_user_data.malware_protection_plans %}
{%- set malware_protection_plan_name = malware_protection_plan.name %}
  {{ malware_protection_plan_name }}:
    Description: Uniqe Id for {{ malware_protection_plan_name }}
    Value:
      Ref: {{ malware_protection_plan_name }}
    Export:
      Name:
        Fn::Sub: "${AWS::StackName}-{{ malware_protection_plan_name }}"
  {{ malware_protection_plan_name }}Arn:
    Description: Amazon Resource Name (ARN) associated with this Malware Protection plan for {{ malware_protection_plan_name }}
    Value:
      Fn::GetAtt:
        - {{ malware_protection_plan_name }}
        - Arn
    Export:
      Name:
        Fn::Sub: "${AWS::StackName}-{{ malware_protection_plan_name }}-Arn"
  {{ malware_protection_plan_name }}CreatedAt:
    Description: The timestamp when the Malware Protection plan {{ malware_protection_plan_name }} was created.
    Value:
      Fn::GetAtt:
        - {{ malware_protection_plan_name }}
        - CreatedAt
    Export:
      Name:
        Fn::Sub: "${AWS::StackName}-{{ malware_protection_plan_name }}-CreatedAt"
  {{ malware_protection_plan_name }}MalwareProtectionPlanId:
    Description: A unique identifier associated with Malware Protection plan {{ malware_protection_plan_name }}
    Value:
      Fn::GetAtt:
        - {{ malware_protection_plan_name }}
        - MalwareProtectionPlanId
    Export:
      Name:
        Fn::Sub: "${AWS::StackName}-{{ malware_protection_plan_name }}-MalwareProtectionPlanId"
  {{ malware_protection_plan_name }}Status:
    Description: Status of the Malware Protection plan {{ malware_protection_plan_name }}
    Value:
      Fn::GetAtt:
        - {{ malware_protection_plan_name }}
        - Status
    Export:
      Name:
        Fn::Sub: "${AWS::StackName}-{{ malware_protection_plan_name }}-Status"
{%- endfor %}{#
# Supported structure as of 2025-07-26
Type: AWS::GuardDuty::MalwareProtectionPlan
Properties:
  ProtectedResource:
    S3Bucket:
      BucketName: String
      ObjectPrefixes:
        - String
  Role: String
  Actions:
    Tagging:
      Status: String
  Tags:
    -
      Key: String
      Value: String
#}