---
template:
  type: file
  path: guardduty/malware-protection-plan.yaml.j2

sceptre_user_data:
  project_code: "{{stack_group_config.project_code}}"
  source_repo_url: "{{git_repo}}"
  description: "GuardDuty Malware Protection Plan Configuration for {{stack_group_config.project_code}}"
  malware_protection_plans:
    # Basic malware protection plan for logs
    - name: LogMalwareProtection
      deletion_policy: Retain
      update_replace_policy: Retain
      protected_resource:
        s3_bucket:
          bucket_name: "{{stack_group_config.project_code}}-logs"
          object_prefixes:
            - "guardduty/"
            - "cloudtrail/"
      role: "arn:aws:iam::123456789012:role/{{stack_group_config.project_code}}-guardduty-role"
      actions:
        tagging:
          status: ENABLED
      tags:
        Environment: Production
        Purpose: Security
        ManagedBy: Sceptre
        ResourceType: Logs

    # Malware protection plan for backups
    - name: BackupMalwareProtection
      deletion_policy: Delete
      update_replace_policy: Delete
      protected_resource:
        s3_bucket:
          bucket_name: "{{stack_group_config.project_code}}-backups"
          object_prefixes:
            - "weekly/"
            - "monthly/"
      role: "arn:aws:iam::123456789012:role/{{stack_group_config.project_code}}-guardduty-role"
      actions:
        tagging:
          status: ENABLED
      tags:
        Environment: Production
        Purpose: Security
        ManagedBy: Sceptre
        ResourceType: Backups

    # Malware protection plan for user uploads
    - name: UserUploadMalwareProtection
      deletion_policy: Retain
      update_replace_policy: Retain
      protected_resource:
        s3_bucket:
          bucket_name: "{{stack_group_config.project_code}}-user-uploads"
          object_prefixes:
            - "documents/"
            - "images/"
      role: "arn:aws:iam::123456789012:role/{{stack_group_config.project_code}}-guardduty-role"
      actions:
        tagging:
          status: ENABLED
      tags:
        Environment: Production
        Purpose: Security
        ManagedBy: Sceptre
        ResourceType: UserUploads
